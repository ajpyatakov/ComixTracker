<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:p="http://primefaces.org/ui"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:c="http://java.sun.com/jsp/jstl/core">
    <h:form id="table">
        <p:dataGrid var="comment"
                    id="comments"
                    value="#{commentsManagedBean.comments}"
                    emptyMessage="No comments"
                    columns="1"
                    rows = "10"
                    paginator="true"
                    paginatorTemplate="{CurrentPageReport} {PageLinks}">
            <p:panel id="comment" header="#{comment.userId.nickname}">
                <f:facet name="actions">
                
                    <p:commandLink
                        styleClass="ui-panel-titlebar-icon ui-corner-all 
                        ui-state-default ui-icon ui-icon-close"
                        action="#{commentsManagedBean.deleteComment(comment)}"
                        rendered="#{commentsManagedBean.isCommentEditable(comment)}"
                        update=":table">
                    </p:commandLink>
                    <p:commandLink
                        rendered="#{commentsManagedBean.isCommentEditable(comment)}"
                        styleClass="ui-panel-titlebar-icon ui-corner-all 
                        ui-state-default ui-icon ui-icon-pencil"
                        update=":edit"
                        action="#{commentsManagedBean.editionStarted(comment)}"
                        oncomplete="PF('commentEditor').show()">
                        <f:setPropertyActionListener
                            target="#{commentsManagedBean.selectedCommentText}"
                            value="#{comment.text}"/>
                    </p:commandLink>
                </f:facet>
                <p:inputTextarea id="commentContent"
                                readonly="true"
                                cols="100"
                                value="#{comment.text}"/>
            </p:panel>
        </p:dataGrid>
    </h:form>
    
    <p:dialog header="Edit comment" widgetVar="commentEditor" modal="true"
              showEffect="fade" hideEffect="fade" closeOnEscape="true">
        <p:panel id="edit" style="height: 70%;">
            <h:form id="editForm" style="height: 70%;">
                <p:inputTextarea 
                    value="#{commentsManagedBean.selectedCommentText}"
                    id="editedComment"
                    style="width: 90%; height: 70%;"/>
                <p:commandButton
                    value="Save"
                    action="#{commentsManagedBean.editComment()}"
                    update="@all"/>
            </h:form>
        </p:panel>
    </p:dialog>
    
    <c:choose>
        <c:when test="#{userRoleManagedBean.isUserAuthorized()}">
            <p:panel id="commentAdder" header="Your comment...">
                <h:form id="commentAdderForm">
                    <p:inputTextarea id="commentAdderNewComment" 
                                    cols="100"/>
                    <br/>
                    <p:commandButton id="commentAdderSubmit" 
                                   value="Send"
                                   action="#{commentsManagedBean.addComment()}"
                                   update="@all"/>
                </h:form>
            </p:panel>
        </c:when>
        <c:otherwise>
            <p:outputLabel value="Please authorize or join us to leave comments."/>
        </c:otherwise>
    </c:choose>
</ui:composition>
