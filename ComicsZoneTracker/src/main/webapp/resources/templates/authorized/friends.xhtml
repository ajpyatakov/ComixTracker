<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/resources/templates/authorized/authorized.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core">
    <ui:define name="articleContent">
        <h:form id="form">
            <p:panel header="Find new friends">
                <p:panelGrid columns="1" >
                    <p:autoComplete
                        id="friendsFinder"
                        maxResults="5"
                        completeMethod="#{userFriendsManagedBean.completeUser}"
                        var="user"
                        value="#{userFriendsManagedBean.selectedUser}"
                        itemValue="#{user}"
                        itemLabel="#{user.nickname}"
                        converter="userConverter"
                        forceSelection="true"
                        dropdown="false">
                        
                        <p:ajax 
                            event="itemSelect" 
                            update=":form:userDetailPanel" 
                            oncomplete="PF('userDetails').show()"/> 

                        <p:column>
                            <p:graphicImage
                                value="#{user.avatarUrl}"
                                width="80"
                                height="80"/>
                        </p:column>

                        <p:column>
                            #{user.nickname}
                        </p:column>
                    </p:autoComplete>
                </p:panelGrid>
            </p:panel>
             
            <table style="width:100%;">
                <tr>
                    <td class="friends-column">
                    <p:dataTable
                        id="friendsTable"
                        var="friend"
                        widgetVar="friendsTable"
                        rowKey="#{friend.userId}"
                        value="#{userFriendsManagedBean.friends}" 
                        paginator="true" 
                        rows="3"
                        paginatorPosition="bottom"
                        paginatorTemplate="{FirstPageLink} {PreviousPageLink} 
                        {CurrentPageReport} {NextPageLink} {LastPageLink}"
                        selectionMode="single" 
                        selection="#{userFriendsManagedBean.selectedFriend}"
                        emptyMessage="No friends found!"
                        style="margin: auto 1% 1% 1%;"
                        >

                        <p:ajax 
                            event="rowSelect" 
                            update=":form:messages"
                            listener="#{messagesManagedBean.setFriendId(userFriendsManagedBean.selectedFriend.userId)}"
                            
                            />

                        <p:column 
                            width="100%" 
                            headerText="Nickname" 
                            sortBy="#{friend.nickname}" 
                            filterBy="#{friend.nickname}">

                            <p:panel header="#{friend.nickname}" >
                            
                                <p:panelGrid 
                                    columns="2" 
                                    columnClasses="friends-avatatar-column-width, 
                                                   friends-info-column-width">
                                <p:graphicImage 
                                        value="#{friend.avatarUrl}"
                                        width="100%"/>
                                
                                <p:panelGrid columns="1">
                                    <h:outputText 
                                        value="#{friend.nickname}"
                                        class="friends-info"
                                        />
                                    
                                    <h:outputText 
                                        value="#{friend.email}" 
                                        class="friends-info"/>
                                    
                                    <h:outputText 
                                        value="#{friend.name}"
                                        rendered="#{friend.name != null}"
                                        class="friends-info"/>
                                    
                                    <h:outputText 
                                        value="#{friend.online}"
                                        rendered="#{friend.online != null}"
                                        class="friends-info"/>
                                    
                                    <p:commandButton 
                                        value="More Info!"
                                        update=":form:friendDetailPanel"
                                        action="#{userFriendsManagedBean.setSelectedInfoFriend(friend)}"
                                        oncomplete="PF('friendDetails').show()"/>
                                    
                                </p:panelGrid>
                            </p:panelGrid>
                            </p:panel>
                        </p:column>
                    </p:dataTable> 
                    </td>
                            
                    <td class="message-column">
                        <p:panel 
                            id="messageAdder" 
                            header="Your message" 
                            style="margin: auto 1% 0 1%">
                            
                        <p:inputTextarea 
                            id="messagesAdderNewMessage" 
                            style="width:100%;"/>
                        <br/>  
                        
                        <div style="float: right;"> 
                        <p:commandButton
                            id="messagesAdderSubmit" 
                            value="Send"
                            action="#{messagesManagedBean.addMessage()}"
                            update=":form:messages :form:messageAdder"/>
                        </div>
                        <p:commandButton
                            id="messagesRefresh" 
                            value="Refresh"
                            update=":form:messages :form:messageAdder"/>
                        
                        </p:panel>

                        <p:growl id="messagessMessage" showDetail="true" life="1000" />
                        
                        <p:confirmDialog
                            message="Are you sure you want to delete comment?"
                            header="Confirm action"
                            widgetVar="deleteConfirm"/>
                        
                        <p:panel style="margin: 0 1% 1% 1%">
                            <p:dataTable 
                                var="message"
                                id="messages"
                                emptyMessage="No messages"
                                paginatorTemplate="{RowsPerPageDropdown} {FirstPageLink} 
                                {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}"
                                value="#{messagesManagedBean.dataModel}" 
                                paginator="true" 
                                rowsPerPageTemplate="10,20,30" 
                                rows="10"
                                lazy="true">
                                
                                <p:column
                                    sortBy="#{message.msgTime}" 
                                    filterBy="#{message.text}" 
                                >
                                <p:panel 
                                    id="messageid" 
                                    header="#{message.sender.nickname}:#{message.msgTime}"
                                    style="text-align: left; background-color: #{message.sender.userId eq messagesManagedBean.currentUser.userId ? '#B7FFFF' : '#C5FFD4'}">
                                    
                                    <f:facet name="actions">
                                        <p:commandLink
                                            styleClass="ui-panel-titlebar-icon ui-corner-all 
                                                ui-state-default ui-icon ui-icon-close"
                                            action="#{messagesManagedBean.deleteMessage(message)}"
                                            update=":form:messages">
                                            <p:confirm
                                                header="Confirm deletion"
                                                message="Are you sure you want to delete this message?"
                                                icon="ui-icon-alert"/>
                                        </p:commandLink>
                                    </f:facet>
                                    <p:panelGrid columns="2" style="background-color: inherit;"
                                                 columnClasses="friend-avatar-message-column,
                                                                friend-message-column">
                                        <p:graphicImage 
                                            value="#{message.sender.avatarUrl}" 
                                            width="100%"
                                            rendered="#{message.sender.avatarUrl != null}"
                                            />
                                        <h:outputText value="#{message.text}" />
                                    </p:panelGrid>
                                </p:panel>
                                    
                                </p:column>
                            </p:dataTable>
                        </p:panel>
                    </td>
                 </tr>
             </table>
                    

            <!--Dialog user window-->
            <p:dialog header="User details" 
                      widgetVar="userDetails" 
                      modal="true" 
                      showEffect="fade" 
                      hideEffect="fade" 
                      resizable="false" 
                      
                      >
                <p:outputPanel id="userDetailPanel" style="text-align:center;">
                    <p:panelGrid  columns="2" 
                                  rendered="#{not empty userFriendsManagedBean.selectedUser}" 
                                  columnClasses="label,value">
                        <f:facet name="header">
                            <p:graphicImage 
                                value="#{userFriendsManagedBean.selectedUser.avatarUrl}"
                                width="100%"
                                rendered="#{userFriendsManagedBean.selectedUser.avatarUrl != null}"
                                />
                            <p:graphicImage
                                alt="NO PHOTO"
                                rendered="#{userFriendsManagedBean.selectedUser.avatarUrl == null}"
                                /> 
                        </f:facet>
                        <f:facet name="footer">
                            <p:outputPanel>
                                <p:commandButton value="Add to friends!"
                                                 update="@all"
                                                 action="#{userFriendsManagedBean.addToFriends}"
                                                 onclick="userDetails.close()"
                                                 
                                                 />
                            </p:outputPanel>
                        </f:facet>

                        <h:outputText value="Id:" />
                        <h:outputText value="#{userFriendsManagedBean.selectedUser.userId}" />

                        <h:outputText value="Nickname" />
                        <h:outputText value="#{userFriendsManagedBean.selectedUser.nickname}" />

                        <h:outputText value="Email" />
                        <h:outputText value="#{userFriendsManagedBean.selectedUser.email}" />

                    </p:panelGrid>
                </p:outputPanel>
            </p:dialog>
            
            
            <!--Dialog friend window-->
            <p:dialog header="Friend details" 
                      widgetVar="friendDetails" 
                      modal="true" 
                      showEffect="fade" 
                      hideEffect="fade" 
                      resizable="false" 
                      appendTo="form"
                      >
                <p:outputPanel id="friendDetailPanel" style="text-align:center;">
                    <p:panelGrid  columns="2" 
                                  rendered="#{not empty userFriendsManagedBean.selectedInfoFriend}" 
                                  columnClasses="label,value">
                        <f:facet name="header">
                            <p:graphicImage 
                                value="#{userFriendsManagedBean.selectedInfoFriend.avatarUrl}"
                                width="200px"
                                height="200px"
                                styleClass="content-image"/> 
                        </f:facet>
                        <f:facet name="footer">
                            <p:outputPanel>
                                <p:commandButton value="Remove from friends!"
                                                 update="@all"
                                                 action="#{userFriendsManagedBean.removeFromFrieds}"
                                                 onclick="userDetails.close()"
                                                 ajax="false"
                                                 />
                            </p:outputPanel>
                        </f:facet>

                        <h:outputText value="Id:" />
                        <h:outputText value="#{userFriendsManagedBean.selectedInfoFriend.userId}" />

                        <h:outputText value="Nickname" />
                        <h:outputText value="#{userFriendsManagedBean.selectedInfoFriend.nickname}" />

                        <h:outputText value="Email" />
                        <h:outputText value="#{userFriendsManagedBean.selectedInfoFriend.email}" />

                    </p:panelGrid>
                </p:outputPanel>
            </p:dialog>
        
        <p:confirmDialog
            global="true"
            widgetVar="confirm">
            
            <p:commandButton
                styleClass="ui-confirmdialog-yes"
                value="Yes"
                type="button"/>
            <p:commandButton
                styleClass="ui-confirmdialog-no"
                value="No"
                type="button"/>
         </p:confirmDialog>
     </h:form>      
            
    </ui:define>
</ui:composition>
